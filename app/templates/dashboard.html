{% extends "base.html" %}
{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - Learning SaaS{% endblock %}
{% block content %}
  <h1 class="h4 mb-3">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <!-- ä¸Šæ®µï¼šå…¨ä½“ã‚µãƒãƒªãƒ¼ -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">å—è¬›ä¸­ã‚³ãƒ¼ã‚¹</p>
          <p class="h4 mb-0">{{ total_courses }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">å®Œäº†ã—ãŸã‚³ãƒ¼ã‚¹</p>
          <p class="h4 mb-0">{{ completed_courses }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">å®Œäº†ã—ãŸãƒ¬ãƒƒã‚¹ãƒ³ï¼ˆç´¯è¨ˆï¼‰</p>
          <p class="h4 mb-0">{{ total_lessons_completed }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">å—é¨“ã—ãŸã‚¯ã‚¤ã‚ºæ•°</p>
          <p class="h4 mb-0">{{ total_quizzes }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒˆãƒªãƒ¼ã‚¯æƒ…å ± -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">ç¾åœ¨ã®é€£ç¶šå­¦ç¿’æ—¥æ•°</p>
          <p class="h4 mb-0">
            {{ current_streak_days }}
            <span class="h6 ms-1">æ—¥</span>
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">éå»æœ€é•·ã®é€£ç¶šå­¦ç¿’æ—¥æ•°</p>
          <p class="h4 mb-0">
            {{ longest_streak_days }}
            <span class="h6 ms-1">æ—¥</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸­æ®µï¼šä»Šæ—¥ãƒ»ä»Šé€±ãƒ»å¹³å‡ã‚¹ã‚³ã‚¢ï¼‹ã‚°ãƒ©ãƒ• -->
  <div class="row g-3 mb-4">
    <div class="col-lg-4 col-12">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <p class="text-muted small mb-1">ä»Šæ—¥å®Œäº†ã—ãŸãƒ¬ãƒƒã‚¹ãƒ³</p>
          <p class="h4 mb-0">{{ today_completed_lessons }}</p>
        </div>
      </div>
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <p class="text-muted small mb-1">ä»Šé€±å®Œäº†ã—ãŸãƒ¬ãƒƒã‚¹ãƒ³</p>
          <p class="h4 mb-0">{{ week_completed_lessons }}</p>
        </div>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <p class="text-muted small mb-1">ã‚¯ã‚¤ã‚ºå¹³å‡æ­£ç­”ç‡</p>
          <p class="h4 mb-0">{{ avg_quiz_score }}<span class="h6 ms-1">%</span></p>
        </div>
      </div>

      <!-- ä»Šé€±ã®ç›®æ¨™é”æˆçŠ¶æ³ -->
      <div class="card border-0 shadow-sm mt-3">
        <div class="card-body">
          <p class="text-muted small mb-1 d-flex justify-content-between align-items-center">
            <span>ä»Šé€±ã®ç›®æ¨™é”æˆçŠ¶æ³</span>
            {% if weekly_goal_percent is not none and weekly_goal_percent >= 100 %}
              <span class="badge bg-success">ä»Šé€±é”æˆï¼</span>
            {% endif %}
          </p>

          {% if weekly_goal_percent is not none and weekly_goal > 0 %}
            <p class="mb-1">
              {{ week_completed_lessons }} / {{ weekly_goal }} ãƒ¬ãƒƒã‚¹ãƒ³
              <span class="small text-muted ms-1">ï¼ˆ{{ weekly_goal_percent }}%ï¼‰</span>
            </p>

            <div class="progress" style="height: 6px;">
              <div class="progress-bar {% if weekly_goal_percent >= 100 %}bg-success{% endif %}"
                   role="progressbar"
                   data-progress="{{ weekly_goal_percent }}"
                   aria-valuenow="{{ weekly_goal_percent }}"
                   aria-valuemin="0"
                   aria-valuemax="100">
              </div>
            </div>
          {% else %}
            <p class="small text-muted mb-0">
              ã¾ã ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰ã€Œä»Šé€±ã®ç›®æ¨™ãƒ¬ãƒƒã‚¹ãƒ³æ•°ã€ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ï¼šç›´è¿‘7æ—¥é–“ã®å®Œäº†ãƒ¬ãƒƒã‚¹ãƒ³æ•° -->
    <div class="col-lg-8 col-12">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small mb-2">ç›´è¿‘7æ—¥é–“ã®å®Œäº†ãƒ¬ãƒƒã‚¹ãƒ³æ•°</p>
          <canvas id="lessonsChart" style="max-height: 260px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- å·¦ï¼šå—è¬›ä¸­ã®ã‚³ãƒ¼ã‚¹ -->
    <div class="col-lg-7">
      <h2 class="h5 mb-2">å—è¬›ä¸­ã®ã‚³ãƒ¼ã‚¹</h2>
      {% if courses %}
        <div class="vstack gap-2">
          {% for course in courses %}
            {% set p = progress_map.get(course.id) %}
            <div class="card border-0 shadow-sm">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div class="flex-grow-1 me-3">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <strong>{{ course.title }}</strong>
                    {% if p and p.is_completed %}
                      <span class="badge bg-success">ã‚³ãƒ¼ã‚¹å®Œäº†</span>
                    {% endif %}
                  </div>
                  {% if course.category or course.level %}
                    <div class="small mb-1">
                      {% if course.category %}
                        <span class="badge bg-secondary me-1">{{ course.category }}</span>
                      {% endif %}
                      {% if course.level %}
                        <span class="badge bg-info text-dark">{{ course.level }}</span>
                      {% endif %}
                    </div>
                  {% endif %}
                  {% if p %}
                    <div class="small text-muted mb-1">
                      {{ p.completed }}/{{ p.total }} ãƒ¬ãƒƒã‚¹ãƒ³ï¼ˆ{{ p.percent }}%ï¼‰
                    </div>
                    <div class="progress" style="height: 6px;">
                      <div
                        class="progress-bar"
                        role="progressbar"
                        data-progress="{{ p.percent }}"
                        aria-valuenow="{{ p.percent }}"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>
                  {% else %}
                    <div class="small text-muted">
                      ã¾ã é€²æ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                    </div>
                  {% endif %}
                </div>
                <a class="btn btn-outline-primary btn-sm"
                   href="{{ url_for('main.course_detail', course_id=course.id) }}">
                  é–‹ã
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>ã¾ã å—è¬›ä¸­ã®ã‚³ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>

    <!-- å³ï¼šæœ€è¿‘ã®å­¦ç¿’ãƒ¬ãƒƒã‚¹ãƒ³ ï¼‹ æœ€è¿‘ã®ã‚¯ã‚¤ã‚ºçµæœ -->
    <div class="col-lg-5">
      <h2 class="h5 mb-2">æœ€è¿‘å®Œäº†ã—ãŸãƒ¬ãƒƒã‚¹ãƒ³</h2>
      {% if recent_lessons %}
        <ul class="list-group mb-3">
          {% for lp in recent_lessons %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ lp.lesson.course.title }}</strong> / {{ lp.lesson.title }}<br>
                <small class="text-muted">
                  å®Œäº†æ—¥: {{ lp.completed_at.strftime("%Y-%m-%d %H:%M") if lp.completed_at else "-" }}
                </small>
              </div>
              <span class="badge bg-success">
                å®Œäº†
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">ã¾ã å®Œäº†ã—ãŸãƒ¬ãƒƒã‚¹ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}

      <h2 class="h5 mb-2 mt-3">æœ€è¿‘ã®ã‚¯ã‚¤ã‚ºçµæœ</h2>
      {% if latest_results %}
        <ul class="list-group">
          {% for r in latest_results %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ r.lesson.course.title }}</strong> / {{ r.lesson.title }}<br>
                <small class="text-muted">
                  å—é¨“æ—¥: {{ r.taken_at.strftime("%Y-%m-%d %H:%M") }}
                </small>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge {% if r.score == r.total_questions %}bg-success{% else %}bg-primary{% endif %}">
                  {{ r.score }} / {{ r.total_questions }}
                </span>
                <a href="{{ url_for('main.quiz_result_detail', result_id=r.id) }}"
                   class="btn btn-outline-secondary btn-sm">
                  è©³ç´°
                </a>
              </div>
            </li>
          {% endfor %}
        </ul>

        <!-- ğŸ”— ã‚¯ã‚¤ã‚ºæˆç¸¾ã‚µãƒãƒªãƒ¼ã¸ã®ãƒªãƒ³ã‚¯ -->
        <div class="mt-2 text-end">
          <a href="{{ url_for('main.quiz_summary') }}"
             class="btn btn-sm btn-outline-primary">
            ã‚¯ã‚¤ã‚ºæˆç¸¾ã‚µãƒãƒªãƒ¼ã‚’è¦‹ã‚‹
          </a>
        </div>
      {% else %}
        <p class="text-muted">ã¾ã ã‚¯ã‚¤ã‚ºçµæœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>
  </div>

  <!-- Chart.js ã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // é€²æ—ãƒãƒ¼ã®å¹…è¨­å®šï¼ˆã‚³ãƒ¼ã‚¹ & é€±é–“ç›®æ¨™ï¼‰
      var bars = document.querySelectorAll('.progress-bar[data-progress]');
      bars.forEach(function (bar) {
        var val = bar.getAttribute('data-progress');
        var num = parseInt(val, 10);
        if (!isNaN(num)) {
          bar.style.width = num + '%';
        }
      });

      // ç›´è¿‘7æ—¥é–“ã®ã‚°ãƒ©ãƒ•
      var ctx = document.getElementById('lessonsChart');
      if (ctx) {
        var labels = JSON.parse('{{ chart_labels | tojson | safe }}');
        var values = JSON.parse('{{ chart_values | tojson | safe }}');

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'å®Œäº†ãƒ¬ãƒƒã‚¹ãƒ³æ•°',
              data: values
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }
    });
  </script>
{% endblock %}
